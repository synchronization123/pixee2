import os
import zipfile
import urllib.request
import shutil
import subprocess
import tempfile
import tkinter as tk
from tkinter import scrolledtext, ttk
import threading
import queue
import time

# =========================================================
# USER HOME
# =========================================================
USER_HOME = os.getenv("USERPROFILE")

# =========================================================
# PATHS
# =========================================================
TOOLS_DIR = os.path.join(USER_HOME, "tools")
PYTHON_DIR = os.path.join(TOOLS_DIR, "python")
NODE_DIR = os.path.join(TOOLS_DIR, "nodejs")
NPM_GLOBAL = os.path.join(TOOLS_DIR, "npm-global")

CODEX_CMD = os.path.join(NPM_GLOBAL, "codex.cmd")

CODEX_DIR = os.path.join(USER_HOME, ".codex")
CONFIG_PATH = os.path.join(CODEX_DIR, "config.toml")

for d in (TOOLS_DIR, PYTHON_DIR, NODE_DIR, NPM_GLOBAL, CODEX_DIR):
    os.makedirs(d, exist_ok=True)

# =========================================================
# URLS
# =========================================================
PYTHON_ZIP_URL = "https://www.python.org/ftp/python/3.12.2/python-3.12.2-embed-amd64.zip"
GET_PIP_URL = "https://bootstrap.pypa.io/get-pip.py"
NODE_ZIP_URL = "https://nodejs.org/dist/v24.12.0/node-v24.12.0-win-x64.zip"

CREATE_NO_WINDOW = 0x08000000

# =========================================================
# SETUP GUI
# =========================================================
class SetupGUI:
    def __init__(self, root):
        self.root = root
        root.title("Codex Setup (No Admin)")
        root.geometry("820x620")

        self.log_box = scrolledtext.ScrolledText(root)
        self.log_box.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        self.progress = ttk.Progressbar(root, mode="indeterminate")
        self.progress.pack(fill=tk.X, padx=10)

        self.q = queue.Queue()
        self.root.after(100, self.process_queue)

        threading.Thread(target=self.run, daemon=True).start()

    def log(self, msg):
        self.q.put(msg)

    def process_queue(self):
        try:
            while True:
                self.log_box.insert(tk.END, self.q.get_nowait() + "\n")
                self.log_box.see(tk.END)
        except queue.Empty:
            pass
        self.root.after(100, self.process_queue)

    # ---------------- SETUP ----------------
    def ensure_python(self):
        if os.path.exists(os.path.join(PYTHON_DIR, "python.exe")):
            self.log("‚úî Python already installed")
            return

        self.log("Installing Python...")
        z = tempfile.mktemp(".zip")
        urllib.request.urlretrieve(PYTHON_ZIP_URL, z)
        zipfile.ZipFile(z).extractall(PYTHON_DIR)
        os.remove(z)

        with open(os.path.join(PYTHON_DIR, "python312._pth"), "a") as f:
            f.write("\nimport site\n")

        p = tempfile.mktemp(".py")
        urllib.request.urlretrieve(GET_PIP_URL, p)
        subprocess.run([os.path.join(PYTHON_DIR, "python.exe"), p])

    def ensure_node(self):
        if os.path.exists(os.path.join(NODE_DIR, "node.exe")):
            self.log("‚úî Node already installed")
            return

        self.log("Installing Node.js...")
        z = tempfile.mktemp(".zip")
        urllib.request.urlretrieve(NODE_ZIP_URL, z)
        zipfile.ZipFile(z).extractall(TOOLS_DIR)
        os.remove(z)

        extracted = next(d for d in os.listdir(TOOLS_DIR) if d.startswith("node-v"))
        shutil.move(os.path.join(TOOLS_DIR, extracted), NODE_DIR)

    def ensure_codex(self):
        if os.path.exists(CODEX_CMD):
            self.log("‚úî Codex already installed")
            return

        self.log("Installing Codex (safe mode)...")
        npm = os.path.join(NODE_DIR, "npm.cmd")

        env = os.environ.copy()
        env["PATH"] = NODE_DIR

        subprocess.run(
            [npm, "config", "set", "prefix", NPM_GLOBAL],
            env=env,
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )

        for attempt in (1, 2):
            try:
                subprocess.run(
                    [npm, "install", "-g", "@openai/codex"],
                    env=env,
                    check=True
                )
                self.log("‚úî Codex installed")
                break
            except subprocess.CalledProcessError:
                if attempt == 1:
                    self.log("‚ö† npm busy, retrying...")
                    time.sleep(2)
                else:
                    self.log("‚ùå Codex install failed")
                    return

    def ensure_config(self):
        if not os.path.exists(CONFIG_PATH):
            open(CONFIG_PATH, "w").close()
            self.log("‚úî config.toml created")

    def run(self):
        self.progress.start()
        self.ensure_python()
        self.ensure_node()
        self.ensure_codex()
        self.ensure_config()
        self.progress.stop()
        self.log("‚úÖ Setup complete")
        self.root.after(800, self.launch_chat)

    def launch_chat(self):
        self.root.destroy()
        root = tk.Tk()
        CodexChat(root)
        root.mainloop()

# =========================================================
# CODEX CHAT
# =========================================================
class CodexChat:
    def __init__(self, root):
        self.root = root
        root.title("Codex Desktop")
        root.geometry("1000x700")

        self.console = scrolledtext.ScrolledText(root, font=("Consolas", 11))
        self.console.pack(fill=tk.BOTH, expand=True)

        self.input = tk.Text(root, height=4)
        self.input.pack(fill=tk.X)

        tk.Button(root, text="Send", command=self.send).pack(pady=5)

    def send(self):
        prompt = self.input.get("1.0", tk.END).strip()
        self.input.delete("1.0", tk.END)

        if not prompt:
            return

        self.console.insert(tk.END, f"\nüë§ You:\n{prompt}\n\n")
        threading.Thread(target=self.run_codex, args=(prompt,), daemon=True).start()

    def run_codex(self, prompt):
        out_file = os.path.join(tempfile.gettempdir(), "codex_out.txt")
        escaped = prompt.replace('"', '`"')

        ps_cmd = f'& "{CODEX_CMD}" "{escaped}" | Out-File -Encoding utf8 "{out_file}"'

        subprocess.run(
            ["powershell.exe", "-NoProfile", "-Command", ps_cmd],
            creationflags=CREATE_NO_WINDOW
        )

        if os.path.exists(out_file):
            with open(out_file, encoding="utf-8") as f:
                self.console.insert(tk.END, f.read())
                self.console.see(tk.END)
            os.remove(out_file)

# =========================================================
# ENTRY
# =========================================================
if __name__ == "__main__":
    root = tk.Tk()
    SetupGUI(root)
    root.mainloop()